{% extends 'core/base.html' %}

{% block extra_css %}
<style>
    #map-container { position: relative; }
    #plotly-map { width: 100%; height: calc(100vh - 120px); }
    #sidebar {
        position: absolute;
        top: 0;
        right: 0;
        width: 350px;
        max-height: calc(100vh - 120px);
        overflow-y: auto;
        display: none;
        z-index: 10;
        background: white;
        border-left: 1px solid #dee2e6;
        box-shadow: -2px 0 8px rgba(0,0,0,.1);
    }
    #sidebar.show { display: block; }
</style>
{% endblock %}

{% block content %}
<div id="map-container" class="mt-3">
    <div id="plotly-map"></div>
    <div id="sidebar">
        <div class="card border-0">
            <div class="card-header d-flex justify-content-between align-items-center bg-dark text-white">
                <strong id="sidebar-title">Similar Companies</strong>
                <button id="sidebar-close" class="btn btn-sm btn-outline-light">&times;</button>
            </div>
            <div class="card-body p-0">
                <ul id="similar-list" class="list-group list-group-flush"></ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const mapDiv = document.getElementById('plotly-map');
    const sidebar = document.getElementById('sidebar');
    const similarList = document.getElementById('similar-list');
    const sidebarTitle = document.getElementById('sidebar-title');
    const sidebarClose = document.getElementById('sidebar-close');

    let allCompanies = [];
    let selectedId = null;
    let similarIds = new Set();

    // Distinct color palette for clusters
    const COLORS = [
        '#636EFA', '#EF553B', '#00CC96', '#AB63FA', '#FFA15A',
        '#19D3F3', '#FF6692', '#B6E880', '#FF97FF', '#FECB52',
        '#1F77B4', '#FF7F0E', '#2CA02C', '#D62728', '#9467BD',
    ];

    function clusterColor(clusterId) {
        if (clusterId == null || clusterId < 0) return '#CCCCCC';
        return COLORS[clusterId % COLORS.length];
    }

    sidebarClose.addEventListener('click', function () {
        sidebar.classList.remove('show');
        selectedId = null;
        similarIds.clear();
        renderPlot();
    });

    fetch('/api/map-data/')
        .then(r => r.json())
        .then(data => {
            allCompanies = data.companies;
            renderPlot();
        });

    function renderPlot() {
        const traces = [];

        if (selectedId !== null) {
            // Three groups: other, similar, selected
            const other = { x: [], y: [], text: [], ids: [], marker: { color: [], size: 5, opacity: 0.3 }, name: 'Other', mode: 'markers', type: 'scatter', hoverinfo: 'text' };
            const sim = { x: [], y: [], text: [], ids: [], marker: { color: 'rgba(255,99,71,0.9)', size: 10 }, name: 'Similar', mode: 'markers', type: 'scatter', hoverinfo: 'text' };
            const sel = { x: [], y: [], text: [], ids: [], marker: { color: 'rgba(34,197,94,1)', size: 14, symbol: 'star' }, name: 'Selected', mode: 'markers', type: 'scatter', hoverinfo: 'text' };

            allCompanies.forEach(c => {
                const label = `${c.name}\n${c.industry}`;
                if (c.id === selectedId) {
                    sel.x.push(c.x); sel.y.push(c.y); sel.text.push(label); sel.ids.push(c.id);
                } else if (similarIds.has(c.id)) {
                    sim.x.push(c.x); sim.y.push(c.y); sim.text.push(label); sim.ids.push(c.id);
                } else {
                    other.x.push(c.x); other.y.push(c.y); other.text.push(label); other.ids.push(c.id);
                    other.marker.color.push(clusterColor(c.cluster_id));
                }
            });
            traces.push(other, sim, sel);
        } else {
            // Group by cluster
            const groups = {};
            allCompanies.forEach(c => {
                const label = c.cluster_label || 'Unknown';
                if (!groups[label]) {
                    groups[label] = { x: [], y: [], text: [], ids: [], clusterId: c.cluster_id };
                }
                groups[label].x.push(c.x);
                groups[label].y.push(c.y);
                groups[label].text.push(`${c.name}\n${c.industry}`);
                groups[label].ids.push(c.id);
            });

            Object.entries(groups).forEach(([label, g]) => {
                traces.push({
                    x: g.x, y: g.y, text: g.text, ids: g.ids,
                    name: label,
                    mode: 'markers',
                    type: 'scatter',
                    hoverinfo: 'text',
                    marker: { color: clusterColor(g.clusterId), size: 6 },
                });
            });
        }

        const layout = {
            margin: { t: 10, r: 10, b: 40, l: 40 },
            xaxis: { title: 'UMAP 1', zeroline: false },
            yaxis: { title: 'UMAP 2', zeroline: false },
            legend: { orientation: 'h', y: -0.15 },
            hovermode: 'closest',
        };

        Plotly.react(mapDiv, traces, layout, { responsive: true }).then(() => {
            mapDiv.on('plotly_click', handleClick);
        });
    }

    function handleClick(data) {
        if (!data.points || data.points.length === 0) return;
        const pt = data.points[0];
        const trace = pt.data;
        const companyId = trace.ids ? trace.ids[pt.pointIndex] : null;
        if (!companyId) return;

        fetch(`/api/similar/${companyId}/?n=10`)
            .then(r => r.json())
            .then(result => {
                if (result.error) return;
                showSimilar(companyId, result.company, result.similar);
            });
    }

    function showSimilar(compId, company, similar) {
        selectedId = compId;
        similarIds = new Set(similar.map(s => s.id));

        sidebarTitle.textContent = `Similar to ${company.name}`;
        similarList.innerHTML = '';

        similar.forEach(s => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.innerHTML = `
                <div>
                    <strong>${s.name}</strong><br>
                    <small class="text-muted">${s.industry}</small>
                </div>
                <span class="badge bg-primary rounded-pill">${s.similarity}%</span>
            `;
            similarList.appendChild(li);
        });

        sidebar.classList.add('show');
        renderPlot();
    }
});
</script>
{% endblock %}
